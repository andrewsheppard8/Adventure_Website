{% extends "base.html" %}

{% block title %}Admin GeoJSON{% endblock %}

{% block content %}
<h1>Manage GeoJSON Features</h1>
<label for="search-city">Search City:</label>
<input type="text" id="search-city" placeholder="Type to search...">
<form method="POST" id="geojson-form">

    <h2>Leaflet Map (Drag markers or click to add new cities)</h2>
    <div id="map" style="height: 600px; margin-bottom:20px;"></div>

    <h2>Existing Cities</h2>
    {% for feature in features %}
    <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
        <h3>Feature {{ loop.index }}</h3>
        <label>City: 
            <input type="text" name="title_{{ loop.index0 }}" value="{{ feature['properties'].get('city','') }}">
        </label><br>
        <label>Date: 
            <input type="date" name="date_{{ loop.index0 }}" value="{{ feature['properties'].get('date','') }}">
        </label><br>
        <label>
            <input type="checkbox" name="delete_{{ loop.index0 }}"> Delete this city
        </label><br>
        <input type="hidden" name="lat_{{ loop.index0 }}" value="{{ feature['geometry']['coordinates'][1] }}">
        <input type="hidden" name="lng_{{ loop.index0 }}" value="{{ feature['geometry']['coordinates'][0] }}">
    </div>
    {% endfor %}

    <hr>
    <h2>Add New City (Optional: click on map to auto-fill coordinates)</h2>
    <label>City Name: <input type="text" name="new_city" id="new_city"></label><br>
    <label>Date: <input type="date" name="new_date" id="new_date"></label><br>
    <label>Latitude: <input type="number" step="any" name="new_lat" id="new_lat"></label><br>
    <label>Longitude: <input type="number" step="any" name="new_lng" id="new_lng"></label><br>

    <button type="submit" style="margin-top:10px;">Save Changes</button>
</form>

<!-- Leaflet CSS/JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// Initialize map
const map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Existing markers
const features = {{ features|tojson }};
features.forEach((feature, idx) => {
    const coords = feature.geometry.coordinates;
    const marker = L.marker([coords[1], coords[0]], {draggable:true}).addTo(map)
        .bindPopup(feature.properties.city);

    marker.on('dragend', (e) => {
        document.querySelector(`input[name="lat_${idx}"]`).value = e.target.getLatLng().lat;
        document.querySelector(`input[name="lng_${idx}"]`).value = e.target.getLatLng().lng;
    });
});

// Click to add new city
map.on('click', function(e) {
    const {lat, lng} = e.latlng;
    document.getElementById("new_lat").value = lat.toFixed(6);
    document.getElementById("new_lng").value = lng.toFixed(6);
});
</script>
{% endblock %}