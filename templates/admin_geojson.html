{% extends "base.html" %}

{% block title %}Admin GeoJSON{% endblock %}

{% block content %}
<div class="admin-page">
    <h1>Manage GeoJSON Features</h1>

    <form method="POST" id="geojson-form">

        <!-- ------------------------- -->
        <!-- Map & Geocoding Search -->
        <!-- ------------------------- -->
        <h2>Leaflet Map (Drag markers or click to add new cities)</h2>

        <div id="geocode-search" style="margin-bottom:10px;">
            <input type="text" id="address-input" placeholder="Enter city or address" style="width:70%; padding:5px;">
            <button type="button" id="geocode-btn" style="padding:6px 12px;">Locate</button>
        </div>

        <div id="map"></div>

        <!-- ------------------------- -->
        <!-- Add New City Form -->
        <!-- ------------------------- -->
        <h2>Add New City (Optional: click on map to auto-fill coordinates)</h2>

        <label>City Name:<br>
            <input type="text" name="new_city" id="new_city" style="width:50%;">
        </label><br><br>

        <label>Date:<br>
            <input type="date" name="new_date" id="new_date">
        </label><br><br>

        <label>Latitude:<br>
            <input type="number" step="any" name="new_lat" id="new_lat">
        </label><br><br>

        <label>Longitude:<br>
            <input type="number" step="any" name="new_lng" id="new_lng">
        </label><br><br>

        <!-- ------------------------- -->
        <!-- Existing Cities -->
        <!-- ------------------------- -->
        <h2>Existing Cities</h2>
        {% for feature in features %}
        <div style="border:1px solid #ccc; padding:10px; margin-bottom:15px; border-radius:6px;">
            <h3>Feature {{ loop.index }}</h3>

            <label>City:<br>
                <input type="text" name="title_{{ loop.index0 }}" value="{{ feature['properties'].get('city','') }}" style="width:50%;">
            </label><br><br>

            <label>Date:<br>
                <input type="date" name="date_{{ loop.index0 }}" value="{{ feature['properties'].get('date','') }}">
            </label><br><br>

            <label>
                <input type="checkbox" name="delete_{{ loop.index0 }}"> Delete this city
            </label><br><br>

            <input type="hidden" name="lat_{{ loop.index0 }}" value="{{ feature['geometry']['coordinates'][1] }}">
            <input type="hidden" name="lng_{{ loop.index0 }}" value="{{ feature['geometry']['coordinates'][0] }}">
        </div>
        {% endfor %}

        <button type="submit" style="margin-top:15px; padding:12px 20px; font-size:1.1em;">Save Changes</button>
    </form>
</div>

<!-- ------------------------- -->
<!-- Leaflet CSS/JS -->
<!-- ------------------------- -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- ------------------------- -->
<!-- Pass GeoJSON from Flask -->
<!-- ------------------------- -->
<script>
    window.geojsonFeatures = {{ features | tojson | safe }};
</script>

<!-- ------------------------- -->
<!-- Admin Map JS -->
<!-- ------------------------- -->
<script src="{{ url_for('static', filename='js/admin_map.js') }}"></script>

<style>
    /* Ensure map renders properly */
    #map {
        width: 100%;
        height: 600px;
        min-height: 400px;
        margin-bottom: 20px;
        border-radius: 8px;
    }

    #geocode-search input {
        max-width: 70%;
    }

    #geocode-search button {
        margin-left: 10px;
    }
</style>

{% endblock %}